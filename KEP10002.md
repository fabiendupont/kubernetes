# [KEP-10002](https://github.com/kubernetes/enhancements/issues/10002): Enhanced Topology Hints for All HintProviders

<!-- toc -->
- [Release Signoff Checklist](#release-signoff-checklist)
- [Summary](#summary)
- [Motivation](#motivation)
  - [Goals](#goals)
  - [Non-Goals](#non-goals)
  - [User Stories](#user-stories)
  - [Notes/Constraints/Caveats](#notesconstraintscaveats)
  - [Risks and Mitigations](#risks-and-mitigations)
- [Proposal](#proposal)
  - [Enhanced TopologyHint Structure](#enhanced-topologyhint-structure)
  - [Distance Matrix Integration](#distance-matrix-integration)
  - [Scoring Formula](#scoring-formula)
  - [Real-World Examples](#real-world-examples)
- [Design Details](#design-details)
  - [DRA Manager Enhancement](#dra-manager-enhancement)
  - [DRA Driver Integration](#dra-driver-integration)
  - [Backward Compatibility](#backward-compatibility)
- [Test Plan](#test-plan)
  - [Unit Tests](#unit-tests)
  - [Integration Tests](#integration-tests)
  - [E2E Tests](#e2e-tests)
- [Graduation Criteria](#graduation-criteria)
- [Upgrade / Downgrade Strategy](#upgrade--downgrade-strategy)
- [Version Skew Strategy](#version-skew-strategy)
- [Feature Enablement and Rollback](#feature-enablement-and-rollback)
- [Production Readiness Review Questionnaire](#production-readiness-review-questionnaire)
- [Implementation History](#implementation-history)
- [Drawbacks](#drawbacks)
- [Alternatives](#alternatives)
- [Infrastructure Needed](#infrastructure-needed)

## Release Signoff Checklist

- [x] **Enhancement Issue**: Enhancement issue in kubernetes/enhancements repo
- [x] **KEP**: KEP has been merged
- [ ] **Code**: Production code complete
- [ ] **Docs**: Documentation complete
- [ ] **Tests**: Unit/integration tests complete
- [ ] **E2E**: End-to-end tests complete
- [ ] **Feature Gate**: Feature gate implemented
- [ ] **Monitoring**: Monitoring and alerting implemented

## Summary

This KEP proposes enhancing the TopologyHint structure used by all HintProviders (CPU Manager, Memory Manager, Device Manager, and DRA Manager) with hop count and bandwidth metrics for more sophisticated resource placement decisions. Additionally, it enhances existing Topology Manager policies with advanced coordination logic and introduces a new `distributed` policy for workloads that benefit from resource distribution across NUMA nodes. While this enhancement benefits all HintProviders, it is driven by DRA's more complex topology awareness requirements that go beyond NUMA node affinity. This builds on the foundation established in KEP-10001.

## Motivation

While basic NUMA topology integration provides fundamental topology awareness, DRA drivers often manage resources with complex interconnect topologies that require more nuanced placement decisions than simple NUMA node affinity. This need for enhanced topology awareness extends beyond DRA to all HintProviders:

- **DRA-specific requirements**: DRA drivers manage diverse resources (GPUs, FPGAs, specialized accelerators) with complex interconnect topologies
- **Interconnect characteristics**: Different paths between NUMA nodes have varying bandwidth and latency
- **Data transfer patterns**: Workloads with high data transfer benefit from bandwidth-aware placement
- **Performance optimization**: Objective metrics enable better placement decisions than simple NUMA affinity
- **Universal benefit**: Enhanced topology hints would benefit CPU, Memory, and Device Managers as well

### Goals

- Extend TopologyHint structure with hop count and bandwidth metrics for all HintProviders
- Implement distance matrix-based scoring for topology decisions
- Enable performance-optimized resource placement based on interconnect characteristics
- Enhance existing Topology Manager policies with advanced coordination logic
- Introduce new `distributed` policy for workloads that benefit from resource distribution
- Maintain backward compatibility with existing TopologyHint structure and policies
- Provide enhanced topology awareness driven by DRA's complex resource requirements

### Non-Goals

- Changing the basic DRA + Topology Manager integration (covered in KEP-10001)
- Supporting subjective performance metrics or workload-dependent cost functions
- Modifying existing Topology Manager policies
- Requiring all HintProviders to provide enhanced topology information
- Breaking backward compatibility with existing TopologyHint consumers

### User Stories

**User Story 1: DRA-Driven Enhanced Topology**
As a DRA driver developer, I want to provide bandwidth and hop count information for my complex resources (GPUs, FPGAs, accelerators) so that the Topology Manager can make informed placement decisions.

**User Story 2: Universal Topology Enhancement**
As a cluster operator, I want all HintProviders (CPU, Memory, Device, DRA) to benefit from enhanced topology hints so that my workloads achieve optimal performance across all resource types.

**User Story 3: Enhanced Policy Coordination**
As a workload developer, I want existing Topology Manager policies to coordinate multiple resource types (CPU + memory + GPU) more intelligently so that my multi-resource workloads achieve optimal performance.

**User Story 4: Distributed Resource Placement**
As a cluster operator, I want a `distributed` topology policy that can spread resources across NUMA nodes for memory-intensive workloads or load balancing scenarios.

**User Story 5: Backward Compatibility**
As an existing HintProvider developer, I want my implementation to continue working without changes when enhanced topology hints are available.

### Notes/Constraints/Caveats

- Enhanced topology hints are optional and backward compatible
- DRA drivers must opt-in to provide enhanced topology information
- Enhanced hints require hardware topology discovery capabilities
- Scoring formulas may need tuning for different hardware architectures

### Risks and Mitigations

**Risk**: Increased complexity in topology decision-making
**Mitigation**: Keep enhanced hints optional and provide clear fallback to basic NUMA affinity

**Risk**: Performance overhead from enhanced scoring
**Mitigation**: Implement efficient scoring algorithms and measure performance impact

**Risk**: Hardware-specific scoring may not be portable
**Mitigation**: Use standardized distance matrix approach similar to Linux kernel

## Proposal

### Enhanced TopologyHint Structure

Extend the existing TopologyHint with objective, measurable metrics:

```go
type TopologyHint struct {
    NUMANodeAffinity bitmask.BitMask
    Preferred        bool
    // Enhanced metrics (optional):
    HopCount         int     `json:"hopCount,omitempty"`         // Number of hops to resource
    Bandwidth        float64 `json:"bandwidth,omitempty"`        // Interconnect bandwidth (GB/s)
    Distance         int     `json:"distance,omitempty"`         // Distance matrix value (10, 20, 30...)
    Score            float64 `json:"score,omitempty"`            // Calculated placement score
}
```

### Distance Matrix Integration

Follow Linux kernel's NUMA distance matrix approach:
- **Local Access**: Distance = 10 (baseline)
- **1-Hop Access**: Distance = 20 (2x latency)
- **2-Hop Access**: Distance = 30 (3x latency)
- **Bandwidth Scaling**: Adjust score based on interconnect bandwidth

### Scoring Formula

Simple, objective scoring based on measurable hardware characteristics:

```go
func calculateTopologyScore(hint TopologyHint, dataSize int64) float64 {
    baseLatency := 10.0  // Local access baseline
    hopLatency := 10.0   // Additional latency per hop
    
    latency := baseLatency + (float64(hint.HopCount) * hopLatency)
    bandwidthPenalty := float64(dataSize) / (hint.Bandwidth * 1024*1024*1024) // Convert to seconds
    
    return latency + bandwidthPenalty
}
```

### Real-World Examples

- **4-Socket Ring Topology**: Local=10, Adjacent=20, Opposite=30
- **2-Socket Mesh**: Local=10, Remote=20
- **GPU Interconnect**: NVLink=300GB/s, PCIe=32GB/s, SoC=16GB/s

### Enhanced Topology Manager Policies

Building on the enhanced topology hints, this KEP also enhances existing Topology Manager policies with advanced coordination logic and introduces a new `distributed` policy:

#### Enhanced Existing Policies

**Enhanced `best-effort` Policy**:
- Uses enhanced topology hints (hop count, bandwidth, score) for better placement decisions
- Adds coordination logic for multiple resource types
- Maintains flexibility while improving placement quality

**Enhanced `restricted` Policy**:
- Uses enhanced topology hints with strict coordination requirements
- Rejects placements that cannot coordinate multiple resource types on single NUMA
- Provides strict performance guarantees

**Enhanced `single-numa-node` Policy**:
- Uses enhanced topology hints with splitting capabilities for large workloads
- Falls back to splitting when single NUMA capacity is exceeded
- Maintains NUMA sensitivity while handling large workloads

#### New `distributed` Policy

**Purpose**: Distribute resources across NUMA nodes for specific use cases
**Use Cases**: 
- Memory-intensive workloads that benefit from distributed memory access
- NUMA-aware applications designed for cross-NUMA access
- Load balancing across NUMA nodes to prevent hotspots
- Multi-tenant scenarios requiring resource isolation

**Implementation**:
```go
type DistributedPolicy struct {
    name string
}

func (p *DistributedPolicy) Merge(providersHints []map[string][]TopologyHint) (TopologyHint, bool) {
    filteredHints := filterProvidersHints(providersHints)
    
    // Use enhanced hint merger with hop count, bandwidth, and score
    merger := NewEnhancedHintMerger(p.numaInfo, filteredHints, p.Name(), p.opts)
    bestHint := merger.Merge()
    
    // Apply distribution logic for multiple resource types
    if p.hasMultipleResourceTypes(providersHints) {
        bestHint = p.applyDistributionLogic(bestHint, providersHints)
    }
    
    admit := p.canAdmitPodResult(&bestHint)
    return bestHint, admit
}
```

## Design Details

### HintProvider Enhancement

All HintProviders (CPU Manager, Memory Manager, Device Manager, DRA Manager) can generate enhanced topology hints by:

1. **Discovering interconnect topology**: Using hwloc-style APIs to discover hop counts and bandwidth
2. **Calculating distance matrices**: Building distance matrices similar to Linux kernel
3. **Computing scores**: Applying the scoring formula for each potential placement
4. **Ranking hints**: Ordering hints by score for optimal placement

**DRA-Specific Implementation**: DRA Manager will be the primary driver of this enhancement due to its complex resource topology requirements, but the enhanced TopologyHint structure will benefit all HintProviders.

### Enhanced Topology Manager Policies

The existing Topology Manager policies are enhanced to leverage the new topology hints and provide better coordination:

#### Enhanced Hint Merging

All policies now use an enhanced hint merger that considers:
- **Hop count**: Prefer lower hop counts for better latency
- **Bandwidth**: Prefer higher bandwidth for better throughput
- **Distance**: Use NUMA distance matrix for scoring
- **Score**: Combined metric for optimal placement

```go
type EnhancedHintMerger struct {
    NUMAInfo *NUMAInfo
    Hints    [][]TopologyHint
    // Enhanced comparison logic
    CompareEnhancedHints func(current, candidate *TopologyHint) *TopologyHint
}

func (m *EnhancedHintMerger) Merge() TopologyHint {
    // Enhanced merging logic that considers hop count, bandwidth, and score
    // in addition to existing NUMA affinity and preference logic
}
```

#### Policy-Specific Enhancements

**Enhanced `best-effort` Policy**:
- Uses enhanced hint merging for better placement decisions
- Adds coordination logic for multiple resource types
- Maintains flexibility while improving placement quality

**Enhanced `restricted` Policy**:
- Uses enhanced hint merging with strict coordination requirements
- Rejects placements that cannot coordinate multiple resource types on single NUMA
- Provides strict performance guarantees

**Enhanced `single-numa-node` Policy**:
- Uses enhanced hint merging with splitting capabilities for large workloads
- Falls back to splitting when single NUMA capacity is exceeded
- Maintains NUMA sensitivity while handling large workloads

**New `distributed` Policy**:
- Uses enhanced hint merging with distribution logic
- Intentionally distributes resources across NUMA nodes
- Suitable for memory-intensive workloads and load balancing scenarios

### DRA Driver Integration

DRA drivers can optionally provide enhanced topology information in ResourceSlice:

```go
type NUMANodeInfo struct {
    NodeID     int                    `json:"nodeId"`
    Resources  map[string]int64       `json:"resources"`
    Properties map[string]string      `json:"properties,omitempty"`
    // Enhanced topology (optional):
    Interconnects []InterconnectInfo  `json:"interconnects,omitempty"`
}

type InterconnectInfo struct {
    TargetNodeID int     `json:"targetNodeId"`
    HopCount     int     `json:"hopCount"`
    Bandwidth    float64 `json:"bandwidth"`    // GB/s
    Latency      int     `json:"latency"`      // Distance matrix value
}
```

### Backward Compatibility

- Enhanced fields are optional and backward compatible
- Existing TopologyHint consumers continue to work unchanged
- DRA drivers can opt-in to enhanced topology information
- Fallback to basic NUMA affinity when enhanced data unavailable

## Test Plan

### Unit Tests
- Test enhanced TopologyHint generation
- Test scoring formula with various inputs
- Test backward compatibility with existing hints

### Integration Tests
- Test with DRA drivers providing enhanced topology information
- Test with mixed enhanced and basic topology hints
- Test performance impact of enhanced scoring

### E2E Tests
- Test end-to-end enhanced topology-aware DRA resource allocation
- Test with real DRA drivers (e.g., GPU resource drivers)
- Test policy compliance and performance impact

## Graduation Criteria

- Enhanced TopologyHint structure implemented
- DRA Manager generates enhanced hints when data available
- Backward compatibility maintained
- Performance impact measured and acceptable
- Documentation updated

### Upgrade / Downgrade Strategy

**Upgrade Strategy:**
- Enhanced topology hints are backward compatible
- Existing DRA drivers continue to work without changes
- New DRA drivers can opt-in to enhanced topology information
- Gradual adoption across the ecosystem

**Downgrade Strategy:**
- Enhanced hints are optional and can be disabled
- Fallback to basic NUMA affinity when enhanced data unavailable
- No breaking changes to existing TopologyHint structure

### Version Skew Strategy

- Enhanced topology hints are optional and backward compatible
- Mixed clusters with enhanced and basic hints work correctly
- Topology Manager handles both enhanced and basic hints gracefully
- No version skew issues expected

### Feature Enablement and Rollback

**Enablement:**
- Feature gate: `EnhancedTopologyHints`
- Default: disabled in alpha, enabled in beta
- Gradual rollout with monitoring

**Rollback:**
- Disable feature gate to fall back to basic NUMA affinity
- No data migration required
- Clean rollback without side effects

## Production Readiness Review Questionnaire

### Feature Enablement and Rollback Planning

- [x] **Feature Gate**: `EnhancedTopologyHints` feature gate defined
- [x] **Rollback**: Clean rollback strategy defined (disable feature gate)
- [x] **Testing**: Unit, integration, and E2E tests planned
- [x] **Monitoring**: Metrics defined for enhanced hint generation and scoring

### Scalability

- [x] **Performance**: Enhanced scoring adds minimal computational overhead
- [x] **Memory**: Optional enhanced hints don't increase memory usage significantly
- [x] **API**: Backward compatible API changes only

### Troubleshooting

- [x] **Debugging**: Enhanced hints include debug information (hop count, bandwidth)
- [x] **Logging**: Clear logging for enhanced hint generation and scoring
- [x] **Metrics**: Prometheus metrics for monitoring enhanced hint adoption

## Implementation History

- Kubernetes 1.36: KEP proposed
- Kubernetes 1.37: Implementation planned

## Drawbacks

- **Increased complexity**: Enhanced hints add complexity to topology decision-making
- **Optional adoption**: DRA drivers must opt-in to provide enhanced information
- **Performance overhead**: Enhanced scoring may add computational overhead

## Alternatives

- **Keep basic NUMA only**: Simpler but less optimal for performance-critical workloads
- **Subjective metrics**: More flexible but harder to implement and maintain
- **Hardware-specific scoring**: More accurate but less portable across different systems

## Infrastructure Needed

- Enhanced TopologyHint structure in Kubernetes API
- HintProvider interface updates for enhanced hint generation
- Optional ResourceSlice extensions for enhanced topology information (DRA-specific)
- Documentation and examples for all HintProvider developers
- hwloc integration for topology discovery across all HintProviders
